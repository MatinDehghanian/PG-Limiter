name: Release PG-Limiter

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Get version from tag or Python file
      id: get_version
      run: |
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        elif grep -q "VERSION\s*=" limiter.py; then
          VERSION=$(python3 -c "import re; content=open('limiter.py').read(); match=re.search(r'VERSION\s*=\s*[\"\'](.*?)[\"\']', content); print(match.group(1) if match else 'latest')")
        else
          VERSION="latest"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Create source archive
      run: |
        mkdir -p release
        # Create tar.gz archive (excluding git and unnecessary files)
        tar --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='*.bak' \
            --exclude='data/' \
            --exclude='logs/' \
            --exclude='dist/' \
            --exclude='build/' \
            --exclude='*.egg-info' \
            -czvf release/pg-limiter-${{ steps.get_version.outputs.version }}.tar.gz .
        
        # Create zip archive
        zip -r release/pg-limiter-${{ steps.get_version.outputs.version }}.zip . \
            -x ".git/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".env" \
            -x "*.bak" \
            -x "data/*" \
            -x "logs/*" \
            -x "dist/*" \
            -x "build/*" \
            -x "*.egg-info/*"
    
    - name: Create/Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: "PG-Limiter ${{ steps.get_version.outputs.version }}"
        body: |
          ## üõ°Ô∏è PG-Limiter ${{ steps.get_version.outputs.version }}
          
          Advanced IP Connection Limiter for PasarGuard Panel with Redis caching, Telegram bot control, and modular architecture.
          
          ### üöÄ Quick Install (Docker - Recommended)
          
          ```bash
          sudo bash <(curl -sSL https://raw.githubusercontent.com/MatinDehghanian/PG-Limiter/main/pg-limiter.sh) install
          ```
          
          ### üì¶ Manual Installation
          
          1. Download and extract the source code
          2. Install dependencies: `pip install -r requirements.txt`
          3. Configure `.env` file
          4. Run: `python3 limiter.py`
          
          ### üê≥ Docker
          
          The Docker image is automatically built and available at:
          ```
          ghcr.io/matindehghanian/pg-limiter:latest
          ```
          
          ### ‚ú® Features
          
          - üîí IP Limiting (global or per-user)
          - üöÄ Redis Caching (with in-memory fallback)
          - ü§ñ Telegram Bot Control
          - üåê REST API
          - üìä Real-time Monitoring
          - ‚öñÔ∏è Punishment System
          - üìù Enhanced Logging
          
          ### üìÑ Changelog
          
          See [CHANGELOG.md](https://github.com/MatinDehghanian/PG-Limiter/blob/main/CHANGELOG.md) for details.
        files: |
          release/pg-limiter-${{ steps.get_version.outputs.version }}.tar.gz
          release/pg-limiter-${{ steps.get_version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
